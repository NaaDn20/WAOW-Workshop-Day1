{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <h2 class="mb-4">üì¶ Product Management</h2>
    
    <div class="card mb-4 shadow-sm">
        <div class="card-header bg-success text-white">
            <h5 class="mb-0">Tambah Product Baru</h5>
        </div>
        <div class="card-body">
            <form id="productForm" class="row g-3">
                <div class="col-md-3">
                    <label class="form-label">Kategori</label>
                    <select id="category_id" class="form-select" required>
                        <option value="">Pilih Kategori</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Nama Product</label>
                    <input type="text" id="name" class="form-control" placeholder="Contoh: Laptop" required>
                </div>
                <div class="col-md-2">
                    <label class="form-label">Harga ($)</label>
                    <input type="number" id="price" class="form-control" placeholder="0.00" step="0.01" required>
                </div>
                <div class="col-md-2">
                    <label class="form-label">Stok</label>
                    <input type="number" id="stock" class="form-control" placeholder="0" required>
                </div>
                <div class="col-md-2 d-flex align-items-end">
                    <button type="submit" class="btn btn-success w-100">‚ûï Simpan</button>
                </div>
            </form>
        </div>
    </div>

    <div class="card shadow-sm">
        <div class="card-header">
            <h5 class="mb-0">Daftar Products</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover align-middle" id="productTable">
                    <thead class="table-dark">
                        <tr>
                            <th>ID</th>
                            <th>Nama</th>
                            <th>Kategori</th>
                            <th>Harga</th>
                            <th>Stok</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    let currentEditingId = null; 

    async function loadCategories() {
        try {
            const response = await fetch('/api/products/categories');
            const categories = await response.json();
            const select = document.getElementById('category_id');
            select.innerHTML = '<option value="">Pilih Kategori</option>'; 
            
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category.CategoryID;
                option.textContent = category.Name;
                select.appendChild(option);
            });
        } catch (error) {
            console.error('Error loading categories:', error);
        }
    }

    async function loadProducts() {
        try {
            const response = await fetch('/api/products');
            const products = await response.json();
            
            const tbody = document.querySelector('#productTable tbody');
            tbody.innerHTML = '';
            
            products.forEach(product => {
                const row = document.createElement('tr');
                let stockBadge = product.Stock < 10 ? 'bg-danger' : 'bg-success';
                
                row.innerHTML = `
                    <td>${product.ProductID}</td>
                    <td class="fw-bold">${product.Name}</td>
                    <td><span class="badge bg-secondary">${product.CategoryName}</span></td>
                    <td>$${parseFloat(product.Price).toFixed(2)}</td>
                    <td><span class="badge ${stockBadge}">${product.Stock}</span></td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary me-1" onclick="editProduct(${product.ProductID})">‚úèÔ∏è Edit</button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteProduct(${product.ProductID})">üóëÔ∏è Delete</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        } catch (error) {
            console.error('Error loading products:', error);
        }
    }

    async function editProduct(id) {
        try {
            const response = await fetch('/api/products');
            const products = await response.json();
            const product = products.find(p => p.ProductID === id);

            if (product) {
                // Populate form
                document.getElementById('category_id').value = product.CategoryID;
                document.getElementById('name').value = product.Name;
                document.getElementById('price').value = product.Price;
                document.getElementById('stock').value = product.Stock;

                currentEditingId = id;

                const btn = document.querySelector('button[type="submit"]');
                btn.textContent = 'üíæ Update Product';
                btn.className = 'btn btn-warning w-100';

                document.querySelector('.card-header').scrollIntoView({ behavior: 'smooth' });
            }
        } catch (error) {
            console.error('Error fetching product for edit:', error);
        }
    }

    document.getElementById('productForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const formData = {
            category_id: parseInt(document.getElementById('category_id').value),
            name: document.getElementById('name').value,
            price: parseFloat(document.getElementById('price').value),
            stock: parseInt(document.getElementById('stock').value)
        };
        
        try {
            let url = '/api/products';
            let method = 'POST';

            if (currentEditingId) {
                url = `/api/products/${currentEditingId}`;
                method = 'PUT';
            }

            const response = await fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(formData)
            });
            
            if (response.ok) {
                document.getElementById('productForm').reset();
                currentEditingId = null;

                const btn = document.querySelector('button[type="submit"]');
                btn.textContent = '‚ûï Simpan';
                btn.className = 'btn btn-success w-100';
                
                loadProducts(); 
            } else {
                alert('Error saving product');
            }
        } catch (error) {
            console.error('Error saving product:', error);
        }
    });

    async function deleteProduct(productId) {
        if (confirm('Are you sure you want to delete this product?')) {
            try {
                const response = await fetch(`/api/products/${productId}`, { method: 'DELETE' });
                if (response.ok) loadProducts();
            } catch (error) {
                console.error('Error deleting product:', error);
            }
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        loadCategories();
        loadProducts();
    });
</script>
{% endblock %}